name: Benchmarks

on:
  workflow_dispatch:

  push:
    branches:
      - main
    paths:
      - 'Benchmarks/**'
      - 'Source/**'

permissions:
  contents: write
  deployments: write

jobs:
  benchmarks:
    name: Benchmarks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Start MongoDB
        run: docker run -p 27017:27017 -d cratis/mongodb

      - name: Build Chronicle Kernel
        run: |
          dotnet build Source/Kernel/Server/Server.csproj -c Release
          dotnet publish Source/Kernel/Server/Server.csproj -c Release -o /tmp/chronicle-server

      - name: Start Chronicle Kernel
        run: |
          cd /tmp/chronicle-server
          nohup dotnet Cratis.Chronicle.Server.dll > /tmp/chronicle.log 2>&1 &

      - name: Wait for Chronicle to be ready
        run: |
          timeout=120
          counter=0
          until curl -f http://localhost:35000/health > /dev/null 2>&1; do
            sleep 2
            counter=$((counter + 2))
            if [ $counter -ge $timeout ]; then
              echo "Timeout waiting for Chronicle to be ready"
              cat /tmp/chronicle.log
              exit 1
            fi
            echo "Waiting for Chronicle... ($counter seconds)"
          done
          echo "Chronicle is ready!"

      - name: Run Benchmarks
        working-directory: ./Benchmarks/Chronicle.Benchmarks
        run: |
          dotnet build -c Release /p:TreatWarningsAsErrors=false
          dotnet run -c Release --no-build -- --exporters json

      - name: Find and Copy Results
        run: |
          mkdir -p Benchmarks/results
          find Benchmarks/Chronicle.Benchmarks/BenchmarkDotNet.Artifacts -name "*.json" -type f -exec cp {} Benchmarks/results/ \;
          ls -la Benchmarks/results/

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Cratis Benchmarks
          tool: 'benchmarkdotnet'
          output-file-path: Benchmarks/results/*.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          # Show alert with commit comment on detecting possible performance regression
          alert-threshold: '120%'
          comment-on-alert: true
          fail-on-alert: true
          alert-comment-cc-users: '@einari'
          gh-pages-branch: 'main'
          skip-fetch-gh-pages: true
          benchmark-data-dir-path: 'Documentation/benchmarks'
